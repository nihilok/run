# Deploy commands

# @desc Increment patch version and deploy
deploy:patch() {
    ./scripts/deploy.sh patch --yes
}

# @desc Increment minor version and deploy
deploy:minor() {
    ./scripts/deploy.sh minor --yes
}

# @desc Increment major version and deploy
deploy:major() {
    ./scripts/deploy.sh major --yes
}

# @desc Full release: patch bump, publish, deploy homebrew + AUR, wait for CI, deploy scoop
deploy:all() {
    # 1. Bump patch version and publish to crates.io
    echo "=== Step 1/4: Bumping patch version and publishing ==="
    deploy:patch

    local ver=$(git describe --tags --abbrev=0 | sed 's/^v//')
    echo ""
    echo "=== Step 2/4: Deploying Homebrew and AUR (source-based, no CI wait) ==="
    deploy:homebrew "$ver"
    deploy:aur "$ver"

    # 3. Wait for the GitHub Actions release workflow to finish
    echo ""
    echo "=== Step 3/4: Waiting for GitHub Actions release workflow ==="
    echo "Waiting for release workflow to start..."
    sleep 10

    local max_wait=600
    local waited=0
    local interval=15
    while [ $waited -lt $max_wait ]; do
        status=$(gh run list --workflow=release.yml --limit=1 --json status,headBranch --jq '.[0].status')
        if [ "$status" = "completed" ]; then
            conclusion=$(gh run list --workflow=release.yml --limit=1 --json conclusion --jq '.[0].conclusion')
            if [ "$conclusion" = "success" ]; then
                echo "✓ Release workflow completed successfully"
                break
            else
                echo "✗ Release workflow failed with conclusion: $conclusion"
                echo "Skipping scoop deploy. Run 'deploy:scoop $ver' manually after fixing."
                return 1
            fi
        fi
        echo "  Workflow status: ${status:-pending}... (${waited}s / ${max_wait}s)"
        sleep $interval
        waited=$((waited + interval))
    done

    if [ $waited -ge $max_wait ]; then
        echo "✗ Timed out waiting for release workflow after ${max_wait}s"
        echo "Run 'deploy:scoop $ver' manually once the workflow completes."
        return 1
    fi

    # 4. Deploy scoop (needs the Windows zip from the release)
    echo ""
    echo "=== Step 4/4: Deploying Scoop manifest ==="
    deploy:scoop "$ver"

    echo ""
    echo "✓ Full release v${ver} complete!"
    echo "  - crates.io: published"
    echo "  - Homebrew: updated"
    echo "  - AUR: updated"
    echo "  - Scoop: updated"
}

# @desc Update Homebrew formula with latest release
# @arg version Optional version (defaults to latest git tag)
deploy:homebrew(version = "") {
    echo "Updating Homebrew formula..."
    if [ -z "$version" ]; then
        ./scripts/update_homebrew.sh
    else
        ./scripts/update_homebrew.sh "$version"
    fi

    local ver="${version:-$(git describe --tags --abbrev=0 | sed 's/^v//')}"
    echo ""
    echo "Committing and pushing changes..."
    cd homebrew-tap
    git add Formula/runtool.rb
    git commit -m "Update to v${ver}"
    git push
    cd ..

    echo "✓ Homebrew formula updated and pushed"
}

# @desc Update Scoop manifest with latest release
# @arg version Optional version (defaults to latest git tag)
deploy:scoop(version = "") {
    echo "Updating Scoop manifest..."
    if [ -z "$version" ]; then
        ./scripts/update_scoop.sh
    else
        ./scripts/update_scoop.sh "$version"
    fi

    local ver="${version:-$(git describe --tags --abbrev=0 | sed 's/^v//')}"
    echo ""
    echo "Committing and pushing changes..."
    cd scoop-bucket
    git add bucket/runtool.json
    git commit -m "Update to v${ver}"
    git push
    cd ..

    echo "✓ Scoop manifest updated and pushed"
}

# @desc Update AUR PKGBUILD with latest release
# @arg version Optional version (defaults to latest git tag)
deploy:aur(version = "") {
    echo "Updating AUR PKGBUILD..."
    if [ -z "$version" ]; then
        ./scripts/update_aur.sh
    else
        ./scripts/update_aur.sh "$version"
    fi

    local ver="${version:-$(git describe --tags --abbrev=0 | sed 's/^v//')}"
    echo ""
    echo "Committing and pushing changes..."
    cd aur-pkgbuild
    git add PKGBUILD .SRCINFO
    git commit -m "Update to v${ver}"
    git push
    git push aur HEAD:master
    cd ..

    echo "✓ AUR PKGBUILD updated and pushed"
}

# Development commands

# @desc Run tests with summary; optionally pass extra args to cargo test
test(...args) {
    output=$(cargo test --package run "$@")
    echo "$output"

    # Parse and display totals
    passed=$(echo "$output" | grep -o '[0-9]\+ passed' | awk '{sum += $1} END {print sum}')
    failed=$(echo "$output" | grep -o '[0-9]\+ failed' | awk '{sum += $1} END {print sum}')
    ignored=$(echo "$output" | grep -o '[0-9]\+ ignored' | awk '{sum += $1} END {print sum}')

    echo ""
    echo "==== TEST SUMMARY ===="
    echo "Total passed:  ${passed:-0}"
    echo "Total failed:  ${failed:-0}"
    echo "Total ignored: ${ignored:-0}"
}

# @desc Run clippy linter on the entire workspace
clippy() {
    cargo clippy --workspace --all-targets || true
}

