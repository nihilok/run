# Example Runfile with simple function definitions

# Simple function with argument substitution
# @desc Open a shell in the specified Docker container
# @arg 1:container The name of the container to open a shell in
docker_shell(container) docker compose exec $container bash

# Nested command with colon notation
# @desc "Open a shell in the specified Docker container (default: app)"
# @arg 1:container "The name of the container to open a shell in"
docker:shell() docker compose exec ${1:-app} bash

# Another nested command example
# @desc "Follow logs for the specified Docker container"
# @arg 1:container "The name of the container to follow logs for"
docker:logs() docker compose logs -f $1

# Function using $@ for all arguments
echo_all() echo "All args: $@"

# Function that ignores arguments
echo_no_args() echo "No args function called" \
    && echo "This function does not use its arguments" \
    && echo "It just prints a fixed message"

# Deploy with multiple steps
docker:deploy() {
    echo "Building image..."
    docker build -t myapp:$1 .
    echo "Pushing to registry..."
    docker push myapp:$1
    echo "Restarting containers..."
    docker compose up -d
    echo "✓ Deployed version $1"
}

# Deploy commands:

# @desc Increment patch version and deploy
deploy:patch() {
    ./scripts/deploy.sh patch --yes
}

# @desc Increment minor version and deploy
deploy:minor() {
    ./scripts/deploy.sh minor --yes
}

# @desc Increment major version and deploy
deploy:major() {
    ./scripts/deploy.sh major --yes
}

# @desc Update Homebrew formula with latest release
# @arg version Optional version (defaults to latest git tag)
deploy:homebrew(version = "") {
    echo "Updating Homebrew formula..."
    if [ -z "$version" ]; then
        ./scripts/update_homebrew.sh
    else
        ./scripts/update_homebrew.sh "$version"
    fi
    
    echo ""
    echo "Committing and pushing changes..."
    cd homebrew-tap
    git add Formula/runtool.rb
    git commit -m "Update to v${version:-$(git describe --tags --abbrev=0 | sed 's/^v//')}"
    git push
    cd ..
    
    echo "✓ Homebrew formula updated and pushed"
}

# @desc Update Scoop manifest with latest release
# @arg version Optional version (defaults to latest git tag)
deploy:scoop(version = "") {
    echo "Updating Scoop manifest..."
    if [ -z "$version" ]; then
        ./scripts/update_scoop.sh
    else
        ./scripts/update_scoop.sh "$version"
    fi
    
    echo ""
    echo "Committing and pushing changes..."
    cd scoop-bucket
    git add bucket/runtool.json
    git commit -m "Update to v${version:-$(git describe --tags --abbrev=0 | sed 's/^v//')}"
    git push
    cd ..
    
    echo "✓ Scoop manifest updated and pushed"
}

# Windows specific command (will not be listed on non-Windows systems)
# @os windows
deploy:example() {
    echo "Running Windows-specific deployment steps..."
    ./scripts/deploy_windows.bat
}

# Will run on unix systems only as windows version is defined above
deploy:example() {
    echo "Running Unix-specific deployment steps..."
    ./scripts/deploy_unix.sh
}

# Will only run on unix systems
# @os unix
incompatible_with_pwsh() echo "" | grep

# Will run in pwsh even on unix systems
# @shell pwsh
pwsh_example() {
    Write-Host "This runs in PowerShell!"
}

# Inline Python
# @shell python
python:hello() {
    print("Hello from inline Python!")
    for i in range(3):
        print(f"Count: {i}")
}

# Inline Node.js
# @shell node
node:hello() {
    console.log("Hello from inline Node.js!");
    for (let i = 0; i < 3; i++) {
        console.log(`Count: ${i}`);
    }
}

# Inline semicolon block
function test_inline() { echo "a"; echo "b"; echo "c" }

# Inline Python using Shebang notation
# @desc Count from 0 to 4 using Python
python:count() {
    #!/usr/bin/env python3
    for i in range(5):
        print(f"Number: {i}")
}

nested() {
    incompatible_with_pwsh
    node:hello
}

# @desc Example function using new signature notation
# @arg some_arg "An example argument"
new_signature_notation(some_arg: int) {
    echo "Argument received: $1"
}


# @desc Function with very long output to test truncation in help
# @arg count "Number of lines to print"
long_output(count) {
    for i in $(seq 1 $count); do
        echo "Line $i: This is a long output example to test truncation in help."
    done
}

# @desc Function that runs tests using Cargo; optionally accepts additional arguments to pass to cargo test (always provides "--package run" by default and captures both stdout and stderr); example:  `run_tests --test some_test.rs`
run_tests(...args) {
    cargo test --package run "$@" 2>&1
}
